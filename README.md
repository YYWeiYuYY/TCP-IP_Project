# 多人線上益智遊戲平台

## 專題成員
- 黃姿婷（11203019A）  
- 莊琇卉（11203011A）  
- 林亮岑（11203105A）  
- 李瑋鈺（11303105A）

---

## 專題簡介
本專題為一個 **多人線上連線益智遊戲平台**，透過 TCP 網路連線機制，讓多位玩家能夠即時互動、同時進行遊戲。

系統整合多款經典益智與娛樂遊戲，玩家可依照喜好選擇不同遊戲模式，目前已實作：

- 大老二（BIG2）
- 21 點（BLACKJACK）
- 井字棋（TTT）
- 輪盤（ROULETTE）

系統支援 **多房間同時遊玩**，可讓多組玩家並行進行不同遊戲。

---

## 功能特色

### 多房間與多玩家支援
- Server 可同時管理多個房間
- 不同遊戲可同時進行
- 各房間彼此獨立、不互相干擾

### 已實作遊戲
- **大老二**
  - 每局固定 4 人
  - 最多 20 間房間

- **21 點**
  - 每局 2～5 人
  - 最多 50 間房間

- **井字棋**
  - 每局 2 人
  - 最多 50 間房間

- **輪盤**
  - 每局 1～20 人
  - 最多 50 間房間

---

## 系統架構設計

### 架構總覽
本系統採用 **Client–Server 架構**：

- **Client**
  - 負責指令輸入與結果顯示
- **Server**
  - 負責所有遊戲邏輯、房間管理與玩家狀態

Client 不參與任何遊戲判斷，確保遊戲公平性。

---

## Client 端設計

Client 為文字介面的 TCP 程式，主要功能如下：

- 建立 TCP 連線  
  `socket.socket()`、`connect()`

- 使用背景執行緒持續接收 Server 訊息  
  `recv_loop()`

- 接收使用者輸入並送出指令  
  `input()`、`sendall()`

- 即時顯示 Server 回傳結果  

### TCP 黏包 / 切包處理
Client 使用 buffer 累積資料，並以 `\n` 作為訊息分隔符號，確保即使一次接收到多筆或不完整資料，也能正確解析。

---

## Server 端設計

Server 為系統核心，功能包含：

- 管理所有 Client 連線
- 為每位玩家建立獨立執行緒
- 玩家登入與暱稱檢查（不可重複）
- 玩家狀態管理（名稱、籌碼、房間）
- 指令解析與狀態分流（Lobby / Game）
- 管理多房間、多遊戲
- 呼叫各遊戲模組處理邏輯

---

## 資料儲存設計

本系統**未使用資料庫**，所有資料皆儲存在記憶體中：

- 玩家資訊（名稱、籌碼、所在房間）
- 房間狀態（玩家清單、遊戲狀態）
- 各遊戲即時資料（牌組、棋盤、下注、底池）

> 設計重點放在 **網路通訊與即時互動邏輯**。

---

## Client–Server 資料傳輸流程

### 訊息格式
- UTF-8 純文字
- 每筆訊息以 `\n` 結尾
- 以 `\n` 作為 TCP 封包切割依據

### Client 流程
1. 使用者輸入指令
2. Client 加上 `\n` 後送出
3. 背景執行緒接收 Server 資料
4. 解析完整訊息並顯示

### Server 流程
1. 為每位 Client 建立執行緒
2. 將資料存入 buffer
3. 偵測 `\n` 判斷完整指令
4. 依玩家狀態分派給 Lobby 或遊戲模組
5. 回傳或廣播結果

---

## 多執行緒與 RLock 機制

Server 使用 `threading.RLock()` 保護共享資料，避免：

- 多人同時加入 / 離開房間造成錯亂
- 同時下注或出牌導致籌碼計算錯誤
- 玩家離線時資料不一致

RLock 為可重入鎖，可避免巢狀鎖導致 deadlock。

---

## 防呆設計
- 指令輸入不分大小寫
- 非法指令回傳錯誤提示
- 房間滿人提示
- 玩家中途離線自動處理

---

## 安裝與執行

### 執行環境
- Python 3.7 以上
- 使用標準函式庫：
  - socket
  - threading
  - random
  - sys

### 執行步驟
1. 啟動 Server
2. Client 連線至 Server
3. 輸入玩家名稱
4. 使用 `HELP` 查看指令

---

## 測試項目與結果

### 測試內容
- 多 Client 同時連線
- 多房間同時遊玩
- 遊戲流程完整性
- 非法指令處理
- 玩家中途離線

### 測試結果
系統可穩定處理多位玩家同時連線，遊戲流程正確，未出現嚴重錯誤。

---

## 未來改進方向
- 前端圖形化介面
- 資料庫儲存玩家紀錄
- 玩家排行榜
- 帳號登入與驗證
- 新遊戲擴充

---

## 參考資料
- Foundations of Python Network Programming
- 老師自編講義
